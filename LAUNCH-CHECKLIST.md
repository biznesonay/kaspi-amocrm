# üöÄ –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–ø—É—Å–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Kaspi ‚Üí amoCRM

## –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 1.1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
npm ci
```
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞: `node_modules` —Å–æ–∑–¥–∞–Ω–∞, –æ—à–∏–±–æ–∫ –Ω–µ—Ç

### 1.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env
```bash
cp .env.example .env
```
–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ `.env`:
- [ ] `KASPI_API_TOKEN` - —Ç–æ–∫–µ–Ω –æ—Ç Kaspi
- [ ] `AMO_BASE_URL` - –≤–∞—à —Å—É–±–¥–æ–º–µ–Ω amoCRM
- [ ] `AMO_CLIENT_ID` - –∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ amoCRM
- [ ] `AMO_CLIENT_SECRET` - –∏–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ amoCRM

## –≠—Ç–∞–ø 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∏ ID

### 2.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Kaspi API
```bash
npm run test:kaspi
```
‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- –ù–∞–π–¥–µ–Ω —Ä–∞–±–æ—á–∏–π endpoint
- –í `.env` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `KASPI_BASE_URL`

### 2.2. –ü–æ–ª—É—á–µ–Ω–∏–µ OAuth —Ç–æ–∫–µ–Ω–æ–≤ amoCRM
```bash
npm run setup:oauth
# –ò–ª–∏:
node src/helpers/setup-amocrm-oauth.js
```
–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ.

‚úÖ –ü–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞ –¥–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
- [ ] `AMO_ACCESS_TOKEN`
- [ ] `AMO_REFRESH_TOKEN`

### 2.3. –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª–µ–π –∏–∑ amoCRM
```bash
npm run get:amocrm-ids
```
‚úÖ –ù–∞–π–¥–∏—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
- [ ] `AMO_PIPELINE_ID` - ID –Ω—É–∂–Ω–æ–π –≤–æ—Ä–æ–Ω–∫–∏
- [ ] `AMO_STATUS_ID` - ID –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

## –≠—Ç–∞–ø 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 3.1. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

#### –î–ª—è SQLite (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):
```bash
sqlite3 integrator.db < migrations/sqlite/001_initial.sql
sqlite3 integrator.db < migrations/sqlite/002_indexes.sql
sqlite3 integrator.db < migrations/sqlite/003_seed_meta.sql
sqlite3 integrator.db < migrations/sqlite/004_error_log_and_stats.sql
```

#### –î–ª—è PostgreSQL:
```bash
# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ë–î
createdb integrator

# –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏
psql integrator < migrations/postgres/001_initial.sql
psql integrator < migrations/postgres/002_indexes.sql
psql integrator < migrations/postgres/003_seed_meta.sql
psql integrator < migrations/postgres/004_error_log_and_stats.sql
```

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# SQLite
sqlite3 integrator.db "SELECT name FROM sqlite_master WHERE type='table';"

# PostgreSQL
psql integrator -c "\dt"
```

## –≠—Ç–∞–ø 4: –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫

### 4.1. –°—É—Ö–æ–π –ø—Ä–æ–≥–æ–Ω (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö)
```bash
# –í .env —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DRY_RUN=true
npm run dry-run:poll
```

‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Kaspi —É—Å–ø–µ—à–Ω–æ
- –ó–∞–∫–∞–∑—ã –ø–æ–ª—É—á–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
- –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

### 4.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ health endpoint
```bash
# –í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
npm run health

# –í –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫—Ä–æ–π—Ç–µ:
# http://localhost:3000/health
# –õ–æ–≥–∏–Ω: admin
# –ü–∞—Ä–æ–ª—å: –∏–∑ ADMIN_BASIC_PASS –≤ .env
```

## –≠—Ç–∞–ø 5: –ë–æ–µ–≤–æ–π –∑–∞–ø—É—Å–∫

### 5.1. –ü–µ—Ä–≤—ã–π —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
```bash
# –í .env —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DRY_RUN=false

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
npm run poll
```

‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
- [ ] –ó–∞–∫–∞–∑—ã –ø–æ—è–≤–∏–ª–∏—Å—å –≤ amoCRM
- [ ] –ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –°—É–º–º—ã –∏ –ø–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### 5.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–≤–µ—Ä–∫–∏
```bash
npm run reconcile
```

‚úÖ –î–æ–ª–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## –≠—Ç–∞–ø 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron

### 6.1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ crontab
```bash
crontab -e
```

–î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫–∏:
```cron
# –û–ø—Ä–æ—Å Kaspi –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
* * * * * cd /path/to/project && /usr/bin/node src/poll-and-create.js >> logs/integrator.log 2>&1

# –°–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
*/10 * * * * cd /path/to/project && /usr/bin/node src/reconcile.js >> logs/integrator.log 2>&1

# Health check (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
@reboot cd /path/to/project && /usr/bin/node src/health-check.js >> logs/health.log 2>&1
```

‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ cron:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á
crontab -l

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ cron
tail -f /var/log/cron
```

## –≠—Ç–∞–ø 7: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 7.1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

#### Telegram:
1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏ chat_id
3. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
   - `ALERT_TELEGRAM_BOT_TOKEN`
   - `ALERT_TELEGRAM_CHAT_ID`

#### Email:
1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ SMTP –¥–æ—Å—Ç—É–ø
2. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:
   - `ALERT_EMAIL_TO`
   - `ALERT_EMAIL_SMTP_*`

### 7.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤
tail -f logs/integrator.log

# –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω pino-pretty)
tail -f logs/integrator.log | npx pino-pretty

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫
grep ERROR logs/integrator.log | tail -20
```

### 7.3. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
```bash
# –°—É–º–º–∞—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
npm run stats:summary

# –ß–µ—Ä–µ–∑ health endpoint
curl -u admin:password http://localhost:3000/health
```

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: "Kaspi API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω: `npm run test:kaspi`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL endpoint –≤ `.env`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Kaspi

### –ü—Ä–æ–±–ª–µ–º–∞: "amoCRM 401 Unauthorized"
- –¢–æ–∫–µ–Ω—ã –∏—Å—Ç–µ–∫–ª–∏, –æ–±–Ω–æ–≤–∏—Ç–µ: `npm run setup:oauth`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ amoCRM

### –ü—Ä–æ–±–ª–µ–º–∞: "Too many requests (429)"
- –£–º–µ–Ω—å—à–∏—Ç–µ `AMO_RPS` –≤ `.env` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ 4)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ—Ç –ª–∏ –¥—Ä—É–≥–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞: "–î—É–±–ª–∏–∫–∞—Ç—ã –∑–∞–∫–∞–∑–æ–≤"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É `processed_orders`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DB lock —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ cron –∑–∞–¥–∞—á

### –ü—Ä–æ–±–ª–µ–º–∞: "–ó–∞–∫–∞–∑—ã –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `KASPI_ALLOWED_STATES` - –≤–æ–∑–º–æ–∂–Ω–æ, –∑–∞–∫–∞–∑—ã –≤ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `AMO_PIPELINE_ID` –∏ `AMO_STATUS_ID` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—à–∏–±–æ–∫ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
npm run clean:errors

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ—à–∏–±–æ–∫ –≤ –ë–î
sqlite3 integrator.db "SELECT * FROM error_log ORDER BY created_at_utc DESC LIMIT 10;"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ heartbeat
sqlite3 integrator.db "SELECT * FROM meta WHERE key='heartbeat_utc';"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
sqlite3 integrator.db "SELECT * FROM daily_stats WHERE date=date('now');"

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–∏—Å)
sqlite3 integrator.db "UPDATE locks SET locked_until_utc=datetime('now') WHERE name='poll';"
```

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

- [ ] `.env` –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Kaspi API –æ—Ç–≤–µ—á–∞–µ—Ç (test:kaspi —É—Å–ø–µ—à–µ–Ω)
- [ ] amoCRM —Ç–æ–∫–µ–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç (get:amocrm-ids —É—Å–ø–µ—à–µ–Ω)
- [ ] –ë–î —Å–æ–∑–¥–∞–Ω–∞ –∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–æ—à–µ–ª –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω
- [ ] Cron –∑–∞–¥–∞—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Health check –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "ok"
- [ ] –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

---

üéâ **–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!** –ï—Å–ª–∏ –≤—Å–µ –ø—É–Ω–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -100 logs/integrator.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health: `http://localhost:3000/health`
3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: `README.md`